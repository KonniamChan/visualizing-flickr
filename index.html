<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Visualizing Flickr</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/agency.css" rel="stylesheet">
    <link href="css/flickr_custom.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">Visualizing Flickr</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#data">Data</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#market">Market</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#cities">Cities</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#wordcloud">Words</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#team">Team</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#resources">Resources</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="intro-text">
                <div class="intro-lead-in">Visualizing Flickr</div>
                <div class="intro-heading">Explore the Cameras and Places Behind 100M Photos</div>
                <a href="#data" class="page-scroll btn btn-xl">MORE</a>
            </div>
        </div>
    </header>

    <!-- Data Section -->
    <section id="data" class='bg-light-gray'>
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h1 class="section-heading">Data</h1>
                </div>
            </div>
            <div class="row text-center">
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-camera fa-stack-1x fa-inverse"></i>
                    </span>
                    <h4 class="service-heading">About</h4>
                    <p class="text-muted large"> Yahoo Flickr Creative Commons 100M <a href="http://webscope.sandbox.yahoo.com/catalog.php?datatype=i&did=67">dataset</a>  consists of Flickr photos licensed under Creative Commons, uploaded from 2004-2014 around the world. Each record contains the photo's metadata, such as the date, location, and camera model.</p>
                </div>
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-tasks fa-stack-1x fa-inverse"></i>
                    </span>
                    <h4 class="service-heading">Visualization Goals</h4>
                    <p class="text-muted large">Enable camera-makers and analysts to explore the state and evolution of photo-taking activities. Specifically, the following visualizations show <em>where</em> Flickr users take photos, with <em>what</em> device, and the <em>type</em> of photos they take, over 2004-2014.</p>
                </div>
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-hdd-o fa-stack-1x fa-inverse"></i>
                    </span>
                    <h4 class="service-heading">Size</h4>
                    <p class="text-muted large"> 99.3M photos + 0.7M videos<br>49M photos geotagged<br>12GB compressed<br>27,000 devices</p>
                </div>
            </div>
        </div>
    </section>


    <!-- Market Section -->
    <section id="market">
        <div class="container">
            <div class="row">
                    <div class="col-lg-12 text-center">
                        <h1 class="section-heading">Market Share</h1>
                        <p class="text-muted large">The following map shows the marketshare of the most popular camera makers in major US cities in each year for which the dataset contains enough data. Flip through the years to see changes over time in each city. The time series plot below shows the marketshare of each popular camera maker in the continental US between 2004 and 2014.</p>
                    </div>
            </div>
            <div class='tableauPlaceholder' style='width: 1004px; height: 869px;'>
                <noscript><a href='#'><img alt='Dashboard 1 ' src='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;Vi&#47;VisualizingFlickr_Marketshares&#47;Dashboard1&#47;1_rss.png' style='border: none' /></a></noscript>
                <object class='tableauViz' width='1004' height='869' style='display:none;'>
                    <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' />
                    <param name='site_root' value='' />
                    <param name='name' value='VisualizingFlickr_Marketshares&#47;Dashboard1' /><param name='tabs' value='no' />
                    <param name='toolbar' value='yes' /><param name='static_image' value='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;Vi&#47;VisualizingFlickr_Marketshares&#47;Dashboard1&#47;1.png' />
                    <param name='animate_transition' value='yes' />
                    <param name='display_static_image' value='yes' />
                    <param name='display_spinner' value='yes' />
                    <param name='display_overlay' value='yes' />
                    <param name='display_count' value='yes' />
                    <param name='showVizHome' value='no' />
                    <param name='showTabs' value='y' />
                    <param name='bootstrapWhenNotified' value='true' />
                </object>
            </div>
        </div>
    </section>

    <!-- Cities Maps Section -->
    <section id="cities" class="bg-light-gray">
        <div class="container">
            <div class="col-lg-12 text-center">
                <h1 class="section-heading">Cities</h1>
                <p class="text-muted large">The following series of <em>hexbin (hexagonal bin)</em> maps focuses on cities around the world. A 20% sample of the 100M photos were used. Each bin contains a number of photos taken at that location. The bin's hue corresponds to the most prevalent camera brand, its saturation to the ratio of the current bin's number of photos to the biggest bin's. <strong>Hover</strong> over each bin to preview a random photo from that bin. <strong>Click</strong> again to view the source of that photo at the lower right corner and to generate a new random photo. <strong>Filter</strong> the time periods using top left buttons. <strong>Hover</strong> over the top right corner link to see an overlay of neighborhoods. </p>
            </div>
            <div class="cities-section">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <h2>San Francisco</h2>
                        <p class="text-muted large">In San Francisco, many photos were taken in downtown (Financial District and Civic Center on the overlay), while not very many were taken in residential areas. Canon and Nikon users dominated traditional landscape locations&ndash;Golden Gate Bridge, Marin Headlands, and Ocean Beach, while Apple users were very active in downtown areas. Observe the growth of smartphones over time using the filter buttons.</p>
                    </div>
                </div>

                <div class="row above-map">
                    <div class="btn-group cities-filter col-md-6" role="group"></div>
                    <div class="col-md-6 neighborhood-hover"></div>
                </div>

            	<div class="cities-maps"></div>
                <div class="row legends">
                    <div class="map-legend col-md-4"></div>
                    <div class="sat-legend col-md-4"></div>
                    <div class="text-muted text-right legend-des col-md-4">
                        <p class="tight-p no-margin-bottom"> Hue: Camera makers<br>Saturation: Photos per bin </p>
                        <p class="attribution tight-p"></p>
                    </div>
                </div>
            </div>

            <div class="cities-section">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <h2>New York</h2>
                        <p class="text-muted large">In New York, photos clustered around Times Square, gradually fanning out towards the peripheral of Manhattan. There is a substantial bias towards Manhattan, as there were not many photos taken outside of it. Post 2012, Apple has carved out substantial territory towards the midtown area (between Theatre District and East Village), while Canon and Nikon have held fast everywhere else.</h3>
                    </div>
                </div>
                <div class="row above-map">
                    <div class="btn-group cities-filter col-md-6" role="group"></div>
                    <div class="col-md-6 neighborhood-hover"></div>
                </div>
                <div class="cities-maps"></div>
                <div class="row legends">
                    <div class="map-legend col-md-4"></div>
                    <div class="sat-legend col-md-4"></div>
                    <div class="text-muted text-right legend-des col-md-4">
                        <p class="tight-p no-margin-bottom"> Hue: Camera makers<br>Saturation: Photos per bin </p>
                        <p class="attribution tight-p"></p>
                    </div>
                </div>
            </div>

            <div class="cities-section">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <h2>Paris</h2>
                        <p class="text-muted large">In Paris, a few hotspots clearly led the pack in terms of photos uploaded. As one might expect, they are the Eiffel Tower, Louvre, Arc de Triomphe, and the Notre Dame. Similar to New York, activity dissipates rapidly towards the edge of the city center. Apple generally was a nonfactor in this city, as the few orange spots originated from the same photographer.</h3>
                    </div>
                </div>
                <div class="row above-map">
                    <div class="btn-group cities-filter col-md-6" role="group"></div>
                    <div class="col-md-6 neighborhood-hover"></div>
                </div>
                <div class="cities-maps"></div>
                <div class="row legends">
                    <div class="map-legend col-md-4"></div>
                    <div class="sat-legend col-md-4"></div>
                    <div class="text-muted text-right legend-des col-md-4">
                        <p class="tight-p no-margin-bottom"> Hue: Camera makers<br>Saturation: Photos per bin </p>
                        <p class="attribution tight-p"></p>
                    </div>
                </div>
            </div>

            <div class="cities-section">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <h2>Hong Kong</h2>
                        <p class="text-muted large">Hong Kong's Flickr usage is much more sparse compared to other cities. Most photos were taken on the two opposite ends of the Victoria Harbour (in the middle of the map), where the famous view of Hong Kong skyscrapers is so often photographed. </h3>
                    </div>
                </div>
                <div class="row above-map">
                    <div class="btn-group cities-filter col-md-6" role="group"></div>
                    <div class="col-md-6 neighborhood-hover"></div>
                </div>
                <div class="cities-maps"></div>
                <div class="row legends">
                    <div class="map-legend col-md-4"></div>
                    <div class="sat-legend col-md-4"></div>
                    <div class="text-muted text-right legend-des col-md-4">
                        <p class="tight-p no-margin-bottom"> Hue: Camera makers<br>Saturation: Photos per bin </p>
                        <p class="attribution tight-p"></p>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- Word Cloud Section -->
    <section id="wordcloud">
        <div class="col-lg-12 text-center">
            <h1 class="section-heading">Word Cloud</h1>
        </div>
      <div class="container">
        <div class="cities-tags-section">
          <div class="row">
            <div class="col-lg-12 text-center">
              <h2>San Francisco Tags</h2>
              <p class="text-muted large">San Francisco's user photo tags highlight locations (e.g. "market", "street", "golden", "gate", "bridge") as well as the lifestyle ("bar", "park", "protest", "gay"), suggesting that people in this city take pictures of tourist attractions as well as of social events that are culturally associated with San Francisco.</p>
            </div>
          </div>
          <div class="btn-group cities-filter" role="group" id="sffilter"></div>
          <div class="cities-tags"></div>
        </div>

      <div class="cities-tags-section">
        <div class="row">
          <div class="col-lg-12 text-center">
            <h2>New York Tags</h2>
            <p class="text-muted large">In New York, photos have tags that mention various boroughs (e.g. "Manhattan", "Brooklyn") as well as the various locations where people visiting the city would tend to take photos (e.g. "art", "museum", "park").</p>
          </div>
        </div>
        <div class="btn-group cities-filter" role="group" id="nyfilter"></div>
        <div class="cities-tags"></div>
      </div>
    </div>

    </section>

    <!-- Team Section -->
    <section id="team" class="bg-light-gray">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Team</h2>
                    <h3 class="section-subheading text-muted">- W209 - </h3>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <div class="team-member">
                        <img src="img/team/katrina.png" class="img-responsive img-circle" alt="">
                        <h4>Katrina Adams</h4>
                        <p class="text-muted">MIDS Student</p>
                        <ul class="list-inline social-buttons">
                            <li><a href="https://github.com/kradams"><i class="fa fa-github"></i></a>
                            </li>
                            <li><a href="https://www.linkedin.com/in/katrinaradams"><i class="fa fa-linkedin"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="team-member">
                        <img src="img/team/konniam.jpg" class="img-responsive img-circle" alt="">
                        <h4>Konniam Chan</h4>
                        <p class="text-muted">MIDS Student</p>
                        <ul class="list-inline social-buttons">
                            <li><a href="http://konniamchan.com"><i class="fa fa-link"></i></a>
                            </li>                            
                            <li><a href="https://github.com/KonniamChan"><i class="fa fa-github"></i></a>
                            </li>
                            <li><a href="https://twitter.com/konniamchan"><i class="fa fa-twitter"></i></a>
                            </li>
                            <li><a href="https://www.linkedin.com/in/konniamchan"><i class="fa fa-linkedin"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="team-member">
                        <img src="img/team/samkabue.jpg" class="img-responsive img-circle" alt="">
                        <h4>Samuel Kabue</h4>
                        <p class="text-muted">MIDS Student</p>
                        <ul class="list-inline social-buttons">
                            <li><a href="https://github.com/samkabue"><i class="fa fa-github"></i></a>
                            </li>
                            <li><a href="https://twitter.com/samkabue"><i class="fa fa-twitter"></i></a>
                            </li>
                            <li><a href="https://www.linkedin.com/in/samkabue"><i class="fa fa-linkedin"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 text-center">
                    <p class="large text-muted">We're all part of UC Berkeley's Master of Information and Data Science (<a href="https://datascience.berkeley.edu/">MIDS</a>) program.<br>Source code for the website on <a href="https://github.com/KonniamChan/visualizing-flickr">Github</a>.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Resources Section -->
    <section id="resources">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Resources</h2>
                </div>
            </div>
            <div class="row text-center">
                <div class="col-md-4">
                    <h4 class="service-heading">Tools</h4>
                    <p class="text-muted large">
                        <a href="http://www.tableau.com/">Tableau</a>
                        <br><a href="http://d3js.org/">D3.js</a>

                        <br><a href="https://mapzen.com/projects/vector-tiles/">Mapzen API</a>
                    </p>
                </div>
                <div class="col-md-4">
                    <h4 class="service-heading">D3 Plugins</h4>
                    <p class="text-muted large">
                        <a href="http://d3-legend.susielu.com/">d3 legend</a>
                        <br><a href="https://github.com/d3/d3-plugins/tree/master/geo">d3 geo</a>
                        <br><a href="https://github.com/d3/d3-plugins/tree/master/hexbin">d3 hexbin</a>
                    </p>
                </div>
                <div class="col-md-4">
                    <h4 class="service-heading">Examples & Books</h4>
                    <p class="text-muted large">
                        <a href="http://bl.ocks.org/mbostock/5616813">Vector Tiles</a>
                        <br><a href="http://bl.ocks.org/mbostock/4330486">Bivariate Hexbin Map</a>
                        <br><a href="http://bl.ocks.org/mbostock/7833311">Dynamic Hexbin</a>
                        <br><a href="https://www.manning.com/books/d3-js-in-action">D3.js in Action</a>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-light-gray">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <span class="copyright">Copyright &copy; Visualizing Flickr 2015</span>
                </div>
                <div class="col-md-4">
                    <ul class="list-inline social-buttons">
                        <li><a href="https://github.com/KonniamChan/visualizing-flickr"><i class="fa fa-github"></i></a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <ul class="list-inline quicklinks">
                        <li><a href="http://startbootstrap.com/template-overviews/agency/">Theme by Start Bootstrap</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="js/jquery.easing.min.js"></script>
    <script src="js/classie.js"></script>
    <script src="js/cbpAnimatedHeader.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/agency.js"></script>

    <!-- D3 Plugins -->
    <script src="js/d3.v3.min.js"></script>
    <script src="js/topojson.v1.min.js"></script>
    <script src="js/queue.v1.min.js"></script>
    <script src="js/d3-legend.min.js"></script>
    <script src="js/d3.hexbin.min.js"></script>
    <script src="js/d3.geo.tile.min.js"></script>
    <script src="js/d3.layout.cloud.js"></script>

    <!-- Tableau JS -->
    <script type='text/javascript' src='https://public.tableau.com/javascripts/api/viz_v1.js'></script>

    <!-- D3 Script -->
    <script>
        var height = Math.max(700, 0.6*window.innerHeight);

        if (window.innerWidth<960) {var width = 960;}
        else if (window.innerWidth>1200) {var width = 1200;}
        else {var width = 0.8*window.innerWidth;}

        function getRandomIntInclusive(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        };

        var tiler = d3.geo.tile()
            .size([width, height]);

        var hexbin = d3.hexbin()
            .size([width, height])
            .radius(20);

        var cities = [
        	{"name": "sanfrancisco", "center": [-122.421356, 37.785839], "file": "data/sf.csv"},
        	{"name": "newyork", "center": [-73.993952, 40.734331], "file": "data/ny.csv"},
            {"name": "paris", "center": [2.338771, 48.859758], "file": "data/paris.csv"},
            {"name": "hongkong", "center": [114.172982, 22.301452], "file": "data/hk.csv"}
            ];

        // Select 5 camera makers
        var camera_makers = ["CANON", "NIKON", "APPLE", "SONY", "PANASONIC"];
        var color_brands = d3.scale.ordinal()
            .domain(camera_makers)
            .range(["#1f78b4", "#33a02c", "#ff7f00", "#6a3d9a", "#e31a1c"]);

        var color_scale = d3.scale.pow()
            .exponent(0.333)
            .interpolate(d3.interpolateHsl);

        // Use D3 to create svg maps
	    d3.selectAll(".cities-maps")
	    	.data(cities)
	    	.append("svg")
	    	.attr("width", width)
	    	.attr("height", height)
	    	.attr("id", function (city) { return city.name; } )
	    	.each( function (city) {

	    		// Vector Tiles
	    		var projection = d3.geo.mercator()
			        .scale((1 << 21) / 2 / Math.PI)
			        .translate([width / 2, height / 2])
			        .center(city.center);
	    		var path = d3.geo.path().projection(projection);
	    		var svg = d3.select(this);

				svg.selectAll("g.roads")
		            .data(tiler
		                .scale(projection.scale() * 2 * Math.PI)
		                .translate(projection([0, 0])))
		            .enter().append("g")
		            .attr("class", "roads")
		            .each(function(d) {
		                var g = d3.select(this);
		                d3.json("http://vector.mapzen.com/osm/roads/" + d[2] + "/" + d[0] + "/" + d[1] + ".topojson?api_key=vector-tiles-6A2EEiQ",
		                	function(error, json) {
			                    var geojson_data = topojson.feature(json, json.objects.vectile);
			                    g.selectAll("path")
			                        .data(geojson_data.features.sort(function(a, b) { return a.properties.sort_key - b.properties.sort_key; }))
			                        .enter().append("path")
			                        .attr("class", function(d) { return d.properties.kind; })
			                        .attr("d", path);
		                	});
		            });

                var hex_g = svg.append("g").attr("class", "hexagons");
		        var filter_selection = d3.select(this.parentNode.parentNode)
                    .select(".above-map").select(".cities-filter");


		        // Hexbins
		        queue()
            		.defer(d3.csv, city.file)
            		.await(ready);
		        function ready(error, flickr) {
		            if (error) throw error;
                    var filter_cats = [
                    {"low":1000, "high":2007, "label":"&mdash;2007"},
                    {"low":2008, "high":2011, "label":"2008&ndash;2011"},
                    {"low":2012, "high":3000, "label":"2012&mdash;"},
                    {"low":1000, "high":3000, "label":"ALL"}
                    ];

		            filter_selection.append("button")
		            	.attr("class", "btn btn-default").attr("type", "button")
		           	    .on("click", function(){ map_viz(flickr, filter_cats[0]); })
		           	    .html(filter_cats[0].label);

		           	filter_selection.append("button")
		            	.attr("class", "btn btn-default").attr("type", "button")
		            	.on("click", function(){ map_viz(flickr, filter_cats[1]); })
		           	    .html(filter_cats[1].label);

		           	filter_selection.append("button")
		            	.attr("class", "btn btn-default").attr("type", "button")
		            	.on("click", function(){ map_viz(flickr, filter_cats[2]); })
		           	    .html(filter_cats[2].label);

		           	filter_selection.append("button")
		            	.attr("class", "btn btn-default").attr("type", "button")
		            	.on("click", function(){ map_viz(flickr, filter_cats[3]); })
		           	    .html(filter_cats[3].label);

		        	// Call map function
		           	map_viz(flickr, filter_cats[3]);
		           	function map_viz(flickr, filter) {
		           		// Project long/lat into pixel coordinates
			            flickr.forEach(function(d) {
			                var p = projection([d.longitude, d.latitude]);
			                d[0] = p[0];
			                d[1] = p[1];
			                d.year = parseInt(d.year);
			            });

			            // Filter
			            var flickr_filtered = flickr.filter(function(d) { return d.year>=filter.low & d.year<=filter.high; });

			            // Create hexbins
			            var hex_flickr = hexbin(flickr_filtered);
			            var global_max = 0;

			            // Get camera counts of each hexbin
			            hex_flickr.forEach(function(hex) {
			                hex.camera_counts = {CANON:0, NIKON:0, APPLE:0, SONY:0, PANASONIC:0};
			                hex.max_camera = "";
			                hex.max_photos = 0;
			                hex.forEach(function(d) {
			                    if (d.camera in hex.camera_counts) {
			                        hex.camera_counts[d.camera] += 1;
			                    };
			                });
			                for (var key in hex.camera_counts){
			                    if (hex.camera_counts[key] > hex.max_photos) {
			                        hex.max_photos = hex.camera_counts[key];
			                        hex.max_camera = key;

			                        if (hex.max_photos > global_max) {
			                        global_max = hex.max_photos;
			                        };
			                    };

			                };
			            });

			            // Remove bins with fewer than minimum number of photos
			            var min_photos = 10;
			            hex_flickr = hex_flickr.filter( function(d) { return d.max_photos>=10; } );

			            // Set color scale
			            color_scale.domain([0, global_max]);

			            // Draw hexagons
                        var hexagons = hex_g.selectAll("path").data(hex_flickr);
                        hexagons
                            .exit()
                            .transition().duration(400)
                            .attr("transform", "translate(" + width + "," + height + ")")
                            .remove();

                        hexagons.enter()
                            .append("path")
                            .attr("d", hexbin.hexagon())
                            .attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";})
                            .style("fill", function(d) {
                                color_scale.range(["white", color_brands(d.max_camera)]);
                                return color_scale(d.max_photos);
                            })
                            .style("opacity", 0.8);

                        hexagons
                            .transition().duration(200)
                            .attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";})
                            .style("fill", function(d) {
                                color_scale.range(["white", color_brands(d.max_camera)]);
                                return color_scale(d.max_photos);
                            })
                            .style("opacity", 0.8);

                        svg.select(".view-indicator").remove();
                        svg.append("text")
                            .attr("class", "view-indicator")
                            .attr("x", 0)
                            .attr("y", 20)
                            .attr("fill", "#202060")
                            .html("View: " + filter.label)
                            .style("opacity", 0.7);

			            // Tooltips
			            svg.select(".hexagons").selectAll("path")
			                .on("mouseover", create_tooltip)
			                .on("mouseout", delete_tooltip)
                            .on("click", new_tooltip);

			            function create_tooltip(d) {
			                d.url_index = getRandomIntInclusive(0, d.length-1);
                            var cur_photo = d[d.url_index];

			                d3.select(this).style("stroke", "#FDB515")
			                	.style("stroke-width", "3px");

			                var hover_tip = d3.select("body")
			                                    .append("div")
			                                    .attr("class", "maptips")
			                                    .attr("display", "inline")
			                                    .style("left", (d3.event.pageX < 2/3*window.innerWidth) ?
                                                    (d3.event.pageX + 10) + "px" :
                                                    (d3.event.pageX - 250 - 10) + "px")
			                                    .style("top", (d3.event.pageY) + "px");

			                hover_tip.append("img")
			                    .attr("src", cur_photo.url)
			                    .attr("class", "img-responsive img-rounded tooltip-image");
			                hover_tip.append("p")
                                .attr("class", "tight-p")
			                    .html(decodeURIComponent(cur_photo.title).slice(0,15) + " by " + decodeURIComponent(cur_photo.user).slice(0,15) +
                                    "<br><small><em>(Click to get source and regenerate)</em></small>"
                                    );

		                    var camera_ref = camera_makers.map( function(k) {
		                        var rObj = {};
		                        rObj["camera"] = k
		                        rObj["count"] = d.camera_counts[k];
		                        return rObj;
		                        });

                            // Barchart
                            var width_barsvg = 250;
                            var height_barsvg = 125;
                            var bar_padding = 5;
                            var text_padding = 30;

                            var bar_length_scale = d3.scale.linear()
                                            .domain([0, d.max_photos])
                                            .range([0, 3/4*width_barsvg - bar_padding - text_padding]);

                            var bar_position_scale = d3.scale.ordinal()
                                                    .domain(d3.range(camera_ref.length))
                                                    .rangeBands([bar_padding, height_barsvg], 0.2);

                            hover_tip.append("svg")
                                .attr("width", width_barsvg)
                                .attr("height", height_barsvg)
                                .selectAll("rect")
                                .data(camera_ref).enter()
                                .append("rect")
                                .attr("x", 1/4*width_barsvg)
                                .attr("y", function (e,i) { return bar_position_scale(i); } )
                                .attr("height", height_barsvg/camera_ref.length - 10)
                                .attr("fill", function (e) { return color_brands(e.camera); } )
                                .attr("width", 0)
                                .transition().duration(500)
                                .delay(function (d,i) { return 300 * i / camera_ref.length})
                                .attr("width", function (e) { return bar_length_scale(e.count); } );

                            hover_tip.select("svg")
                                .append("g")
                                .selectAll("text")
                                .data(camera_ref).enter()
                                .append("text")
                                .attr("x", bar_padding)
                                .attr("y", function (e,i) { return bar_position_scale(i); })
                                .attr("dominant-baseline", "hanging")
                                .text(function (e) { return e.camera.slice(0,5); })

                            hover_tip.select("svg")
                                .append("g")
                                .selectAll("text")
                                .data(camera_ref).enter()
                                .append("text")
                                .attr("y", function (e,i) { return bar_position_scale(i); })
                                .attr("dominant-baseline", "hanging")
                                .attr("text-anchor", "start")
                                .text(function (e) { return e.count; })
                                .attr("fill", "#808080")
                                .attr("x", 1/4*width_barsvg)
                                .transition().duration(500)
                                .delay(function (d,i) { return 300 * i / camera_ref.length})
                                .attr("x", function (e) { return 1/4*width_barsvg + bar_length_scale(e.count) + 2; });
			            };

			            function delete_tooltip(d) {
			            	d3.select(this)
			            		.transition()
			            		.duration(200)
			                	.style("stroke-width", "0px");
			                d3.select(".maptips").remove();
			            };

                        function new_tooltip(d) {
                            hover_tip = d3.select(".maptips");
                            var last_photo = d[d.url_index];
                            var page = "http://www.flickr.com/photos/" + last_photo.nsid + "/" + last_photo.identifier;
                            var cc_url = "http://creativecommons.org/licenses/" + last_photo.license + "/2.0/";

                            d3.select(this.parentNode.parentNode.parentNode.parentNode)
                                .select(".legend-des").select(".attribution")
                                .html("<a href='" + page + "'>Last Photo</a> by " + decodeURIComponent(last_photo.user).slice(0,15) +
                                    " (<a href='" + cc_url + "'>CC " +  last_photo.license.toUpperCase() + " 2.0</a>)");

                            d.url_index = getRandomIntInclusive(0, d.length-1);
                            var cur_photo = d[d.url_index];
                            hover_tip.select("img")
                                .attr("src", cur_photo.url);
                            hover_tip.select("p")
                                .html(decodeURIComponent(cur_photo.title).slice(0,15) + " by " + decodeURIComponent(cur_photo.user).slice(0,15) +
                                    "<br><small><em>(Click to get source and regenerate)</em></small>");

                        };
		           	}; //mapviz
		        }; //ready

                svg.selectAll("g.places")
                    .data(tiler
                        .scale(projection.scale() * 2 * Math.PI)
                        .translate(projection([0, 0])))
                    .enter().append("g")
                    .attr("class", "places")
                    .each(function(d) {
                        var g = d3.select(this);
                        d3.json("http://vector.mapzen.com/osm/places/" + d[2] + "/" + d[0] + "/" + d[1] + ".topojson?api_key=vector-tiles-6A2EEiQ", function(error, json) {
                            var geojson_data = topojson.feature(json, json.objects.vectile);
                            g.selectAll("text")
                                .data(geojson_data.features)
                                .enter().append("text")
                                .attr("class", function (e) { return (parseInt(e.properties.kind_tile_rank)<=3 || e.properties.kind=="city")
                                    ? e.properties.kind : "exclude"; })
                                .attr("x", function (e) { return projection(e.geometry.coordinates)[0]; })
                                .attr("y", function (e) { return projection(e.geometry.coordinates)[1]; })
                                .attr("text-anchor", "middle")
                                .text(function (e) { return e.properties.name; });
                        });
                    });
                svg.selectAll("g.places").attr("display", "none");

                var neighbor_selection = d3.select(this.parentNode.parentNode)
                    .select(".above-map").select(".neighborhood-hover");

                neighbor_selection.append("button")
                    .attr("class", "btn btn-link btn-neighborhood").attr("type", "button")
                    .on("mouseover", function() { svg.selectAll("g.places").attr("display", null); } )
                    .on("mouseout", function() { svg.selectAll("g.places").attr("display", "none"); } )
                    .html("Neighborhoods (<em>Hover Here</em>)");

			}); //each

        // OSM Attribution
        d3.selectAll(".cities-maps").append("div")
            .attr("class", "info text-right")
            .html('© <a href="https://www.openstreetmap.org/copyright" target="_top">OpenStreetMap contributors</a> | <a href="https://mapzen.com/projects/vector-tiles" title="Tiles courtesy of Mapzen" target="_top">Mapzen</a>');

        // Map Legends (cameras)
        var map_legend = d3.selectAll(".map-legend")
            .append("svg")
            .attr("width", width/3)
            .attr("height", 50);

        map_legend.append("g")
            .attr("class", "legendOrdinal")
            .attr("transform", "translate(20,20)");

        var legendOrdinal = d3.legend.color()
            .shape("path", hexbin.hexagon(12))
            .shapePadding(50)
            .orient("horizontal")
            .scale(color_brands);

        map_legend.select(".legendOrdinal")
            .call(legendOrdinal);

        // Saturation Legends
        var color_scale_sat = color_scale
                                .domain([0, 100])
                                .range(["white", "#1f78b4"]);

        var sat_legend = d3.selectAll(".sat-legend")
            .append("svg")
            .attr("width", width/3)
            .attr("height", 50);

        sat_legend.append("g")
            .attr("class", "legendSat")
            .attr("transform", "translate(20,20)");

        var legendSat = d3.legend.color()
            .shape("path", hexbin.hexagon(12))
            .shapePadding(50)
            .orient("horizontal")
            .cells([1,10,20,50,100])
            .labelFormat(d3.format("d"))
            .scale(color_scale_sat);

        sat_legend.select(".legendSat")
            .call(legendSat);

        // Wordclouds
        var city_tags = [
          {"name": "sanfrancisco", "tagfile": "data/sf_tags.csv", "max": 26000},
          {"name": "newyork", "tagfile": "data/ny_tags.csv", "max": 25000}
        ];
        var svg_words_height = 500;

        d3.selectAll(".cities-tags")
          .data(city_tags)
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .attr("id", function (city) { return city.name; })
          .each(function (city) {
            var tags_svg = d3.select(this);
            var tags_g = tags_svg.append("g").attr("class", "tags");
            var tags_filter = d3.select(this.parentNode.parentNode)
              .select(".cities-filter");

            var tags_cats = [
              {"low":1000, "high":2007, "label":"&mdash;2007"},
              {"low":2008, "high":2011, "label":"2008&ndash;2011"},
              {"low":2012, "high":3000, "label":"2012&mdash;"},
              {"low":8999, "high":9001, "label":"ALL"}
            ];

            queue()
              .defer(d3.csv, city.tagfile)
              .await(tags_ready);

            function tags_ready(error, data) {
              if (error) throw error;

              tags_filter.append("button")
                .attr("class", "btn btn-default").attr("type", "button")
                .on("click", function() { draw_cloud(data, tags_cats[0]); })
                .html(tags_cats[0].label);

              tags_filter.append("button")
                .attr("class", "btn btn-default").attr("type", "button")
                .on("click", function() { draw_cloud(data, tags_cats[1]); })
                .html(tags_cats[1].label);

              tags_filter.append("button")
                .attr("class", "btn btn-default").attr("type", "button")
                .on("click", function() { draw_cloud(data, tags_cats[2]); })
                .html(tags_cats[2].label);

              tags_filter.append("button")
                .attr("class", "btn btn-default").attr("type", "button")
                .on("click", function() { draw_cloud(data, tags_cats[3]); })
                .html(tags_cats[3].label);

              draw_cloud(data, tags_cats[3]);

              function draw_cloud(data, filter) {
                d3.layout.cloud()
                  .size([width, height])
                  .words(data)
                  .padding(5)
                  .on("end", draw)
                  .start();

                function draw(words) {
                  var city_div = "#" + city.name;
                  var fill = d3.scale.category20();

                  tags_svg
                    .select("g")
                    .remove();

                  tags_svg
                    .append("g")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("transform", "translate(300,300)")
                    .selectAll("text")
                    .data(data)
                    .enter().append("text")
                    .filter(function(d) {return d.count > 750 && d.year >= filter.low && d.year <= filter.high;})
                    .style("font-size", function(d) { return Math.min(Math.round(d.count*150/city.max), 85) + "px"; })
                    .style("fill", function(d, i) { return fill(i); })
                    .attr("text-anchor", "middle")
                    .attr("transform", function(d) { return "translate(" + [d.x, d.y] + ")rotate(" + ~~(Math.random() * 2) * 90 + ")"; })
                    .text(function(d) { return d.tag; });
                }
              }
            }
          }
        );
    </script>
</body>
</html>
